@page "/reporteread"
@layout AdminLayout
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Authorization
@using ClientApp.Services.IService
@using SharedApp.Models.Dtos
@inject ILocalStorageService LocalStorageService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<div class="chart-container">
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <h5 class="text-primary text-center">@Titulo_vw_ProfesionalCalificado</h5>
            <div class="chart-wrapper">
                <canvas id="chart1" class="chart"></canvas>
                <div class="button-container">
                    <button class="export-btn-icon" onclick="exportChartToExcel('chart1', 'ProfesionalCalificado')" title="Exportar a Excel">
                        <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png" alt="Exportar Excel">
                    </button>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
            <h5 class="text-primary text-center">@Titulo_vw_ProfesionalOna</h5>
            <div class="chart-wrapper">
                <canvas id="chart2" class="chart"></canvas>
                <div class="button-container">
                    <button class="export-btn-icon" onclick="exportChartToExcel('chart2', 'ProfesionalOna')" title="Exportar a Excel">
                        <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png" alt="Exportar Excel">
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <h5 class="text-primary text-center">@Titulo_vw_ProfesionalEsquema</h5>
            <div class="chart-wrapper">
                <canvas id="chart3" class="chart"></canvas>
                <div class="button-container">
                    <button class="export-btn-icon" onclick="exportChartToExcel('chart3', 'ProfesionalEsquema')" title="Exportar a Excel">
                        <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png" alt="Exportar Excel">
                    </button>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
            <h5 class="text-primary text-center">@Titulo_vw_ProfesionalFecha</h5>
            <div class="chart-wrapper">
                <canvas id="chart4" class="chart"></canvas>
                <div class="button-container">
                    <button class="export-btn-icon" onclick="exportChartToExcel('chart4', 'ProfesionalFecha')" title="Exportar a Excel">
                        <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png" alt="Exportar Excel">
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <h5 class="text-primary text-center">@Titulo_vw_CalificaUbicacion</h5>
            <div id="heatmap1" class="heatmap"></div>
        </div>
    </div>
</div>

<script>
    window.exportChartToExcel = (chartId, fileName) => {
        const canvas = document.getElementById(chartId);
        if (!canvas) {
            console.error(`No se encontró el gráfico con ID ${chartId}`);
            return;
        }

        const chart = Chart.getChart(canvas);
        if (!chart) {
            console.error(`No se encontró el objeto Chart.js para ${chartId}`);
            return;
        }

        const labels = chart.data.labels;
        const data = chart.data.datasets[0].data;

        // Crear hoja de Excel con los datos
        let ws_data = [['Categoría', 'Valor']];
        labels.forEach((label, index) => {
            ws_data.push([label, data[index]]);
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");

        // Descargar archivo
        XLSX.writeFile(wb, `${fileName}.xlsx`);
    };


    window.initCharts = (chartsData) => {
        const createPieChart = (elementId, data) => {
            const canvas = document.getElementById(elementId);
            if (!canvas || canvas.tagName !== 'CANVAS') {
                console.error(`El elemento con ID ${elementId} no es un <canvas> o no existe.`);
                return;
            }

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.label || 'Sin etiqueta'),
                    datasets: [{
                        data: data.map(item => item.value || 0),
                        backgroundColor: ['#6c63ff', '#63a4ff', '#00d1b2', '#ffdd57'],
                        borderWidth: 2,
                        borderColor: '#fff',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.label}: ${tooltipItem.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        };

        const createLineChart = (elementId, data) => {
            const canvas = document.getElementById(elementId);
            if (!canvas || canvas.tagName !== 'CANVAS') {
                console.error(`El elemento con ID ${elementId} no es un <canvas> o no existe.`);
                return;
            }

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.label || 'Sin fecha'),
                    datasets: [{
                        label: 'E&E calificados',
                        data: data.map(item => item.value || 0),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        fill: true,
                        tension: 0.4 // Suavizado de la curva
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: ''
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profesionales'
                            }
                        }
                    }
                }
            });
        };

        // Inicializar gráficos
        createPieChart('chart1', chartsData[0]);
        createPieChart('chart2', chartsData[1]);
        createPieChart('chart3', chartsData[2]);
        createLineChart('chart4', chartsData[3]);
    };

    window.initHeatMaps = (mapsData) => {
        const createHeatMap = (elementId, data) => {
            if (typeof L === 'undefined') {
                console.error("Leaflet.js no está cargado correctamente.");
                return;
            }

            const map = L.map(elementId).setView([20, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            data.forEach(item => {
                const marker = L.circleMarker([0, 0], {
                    radius: item.organizacion > 50 ? 20 : item.organizacion > 20 ? 15 : 10,
                    color: 'red',
                    fillColor: item.organizacion > 50 ? 'red' : item.organizacion > 20 ? 'orange' : 'yellow',
                    fillOpacity: 0.7,
                    weight: 1
                }).bindPopup(`<strong>País:</strong> ${item.pais}<br><strong>Calificados:</strong> ${item.organizacion}`);

                fetch(`https://nominatim.openstreetmap.org/search?q=${item.pais}&format=json&limit=1`)
                    .then(response => response.json())
                    .then(locations => {
                        if (locations.length > 0) {
                            marker.setLatLng([locations[0].lat, locations[0].lon]).addTo(map);
                        } else {
                            console.error(`No se encontraron coordenadas para ${item.pais}`);
                        }
                    })
                    .catch(err => console.error(`Error al buscar coordenadas para ${item.pais}:`, err));
            });
        };

        createHeatMap('heatmap1', mapsData.heatmap1);
    };

    window.initMap = (data) => {
        window.initCharts(data.chartsData);
        window.initHeatMaps(data.mapsData);
    };
</script>

<style>
    .chart-container {
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .chart-wrapper {
        width: 100%;
        max-width: 400px;
        position: relative;
    }

    .chart {
        width: 100%;
        height: auto;
    }

    .heatmap {
        height: 300px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    h5 {
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
    }

    .text-primary {
        color: #007bff;
    }

    .mb-4 {
        margin-bottom: 1.5rem;
    }

    /* exportar */
    .chart-container {
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }

    .chart-wrapper {
        width: 100%;
        max-width: 400px;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .title-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-bottom: 10px;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: -20px; /* Ajuste para subir un poco el botón */
        width: 100%;
    }

    .export-btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        width: 48px; /* Aumentado el tamaño */
        height: 48px; /* Aumentado el tamaño */
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .export-btn-icon img {
            width: 100%;
            height: auto;
        }
</style>
